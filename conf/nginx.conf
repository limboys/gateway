# nginx.conf - OpenResty 配置文件

user root;
env ZERION_API_KEY;
env COINGECKO_API_KEY;
env ALCHEMY_API_KEY;
env REDIS_ENABLED;
env REDIS_HOST;
env REDIS_PORT;
env REDIS_DB;
env REDIS_PASSWORD;
env REDIS_TIMEOUT_MS;
env REDIS_POOL_SIZE;
env REDIS_KEEPALIVE_MS;
env STRESS_TEST_MODE;  # ⚡ 添加压测模式环境变量
worker_processes auto;
error_log /var/log/nginx/error.log info;
pid /usr/local/openresty/nginx/logs/nginx.pid;

events {
    worker_connections 8192;  # 压测模式下提高连接数 (从 4096 提升到 8192)
    use epoll;                # Linux 下使用 epoll
    multi_accept on;          # 允许一次接受多个连接
}

http {
    include /usr/local/openresty/nginx/conf/mime.types;
    default_type application/json;

    # 日志格式 - JSON格式便于分析
    log_format json_combined escape=json
        '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for"'
        '}';

    access_log /var/log/nginx/access.log json_combined;

    # 基础设置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 75;      # 增加 keepalive 超时 (从 65 到 75)
    keepalive_requests 1000;   # 每个连接最多处理 1000 个请求
    types_hash_max_size 2048;
    client_max_body_size 10m;
    client_body_buffer_size 128k;  # 增加 body 缓冲区

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # DNS Resolver - 用于解析 Docker 容器名称
    resolver 127.0.0.11 valid=30s ipv6=off;
    
    # Lua 模块路径
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";
    
    # Shared Dict 配置 - 用于存储指标、熔断器状态、限流等
    lua_shared_dict metrics 20m;           # 指标数据 (从 10m 增加到 20m)
    lua_shared_dict circuit_breaker 10m;   # 熔断器状态 (从 5m 增加到 10m)
    lua_shared_dict rate_limit 20m;        # 限流数据 (从 10m 增加到 20m)
    lua_shared_dict response_cache 50m;    # 降级缓存 (从 20m 增加到 50m)

    # 初始化
    init_by_lua_block {
        local metrics = require "metrics"
        metrics.init()
    }

    # 主服务器配置
    server {
        listen 8080;
        server_name _;

        # 健康检查端点
        location = /health {
            access_log off;
            default_type application/json;
            content_by_lua_block {
                ngx.say('{"status": "healthy", "timestamp": ' .. ngx.now() .. '}')
            }
        }

        # Prometheus 指标端点
        location = /metrics {
            access_log off;
            default_type text/plain;
            content_by_lua_block {
                local metrics = require "metrics"
                ngx.say(metrics.export_prometheus())
            }
        }

        # 内部状态端点
        location = /status {
            access_log off;
            default_type application/json;
            content_by_lua_block {
                local cjson = require "cjson"
                local circuit_breaker = require "circuit_breaker"
                local config = require "config"
                
                local status = {
                    timestamp = ngx.now(),
                    providers = {}
                }
                
                for name, _ in pairs(config.providers) do
                    status.providers[name] = circuit_breaker.get_stats(name)
                end
                
                ngx.say(cjson.encode(status))
            }
        }

        # API 代理路由 - Zerion
        location ~ ^/zerion(/|$) {
            # 代理处理
            content_by_lua_block {
                local proxy = require "proxy"
                proxy.handle_request()
            }
        }

        # API 代理路由 - CoinGecko
        location ~ ^/coingecko(/|$) {
            content_by_lua_block {
                local proxy = require "proxy"
                proxy.handle_request()
            }
        }

        # API 代理路由 - Alchemy
        location ~ ^/alchemy(/|$) {
            content_by_lua_block {
                local proxy = require "proxy"
                proxy.handle_request()
            }
        }

        location /circuit-breaker-stats {
            content_by_lua_block {
                local admin = require "admin"
                admin.circuit_breaker_stats()
            }
        }

        # 默认路由 - 404
        location / {
            default_type application/json;
            return 404 '{"error": "Route not found"}';
        }
    }
}
